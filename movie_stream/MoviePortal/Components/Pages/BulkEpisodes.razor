@page "/tools/bulk-episodes"
@rendermode InteractiveServer
@using MoviePortal.Models.ValueObject
@inherits MoviePortal.Components.Pages.BulkEpisodesPage

<PageTitle>Tạo tập hàng loạt</PageTitle>

<h3 class="mb-3 d-flex align-items-center gap-2">
  <i class="bi bi-list-ol"></i> Tạo tập hàng loạt
</h3>

<div class="card mb-3">
  <div class="card-header">1) Chọn phim</div>
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Tìm phim theo tiêu đề</label>
        <input class="form-control" placeholder="Nhập từ khoá..." @bind="Search" @bind:event="oninput" />
      </div>
      <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" @onclick="SearchMoviesAsync">
          <i class="bi bi-search me-1"></i> Tìm
        </button>
      </div>
      <div class="col-md-3">
        <label class="form-label">Kết quả</label>
        <InputSelect class="form-select" @bind-Value="Form.MovieId" @onchange="OnMovieChanged">
          <option value="">-- Chọn phim --</option>
          @foreach (var m in MovieOptions)
          {
            <option value="@m.Id">@m.Title (@m.Type)</option>
          }
        </InputSelect>
      </div>
    </div>

    @if (SelectedMovie is not null)
    {
      <div class="alert @( SelectedMovie.Type == MovieType.Series ? "alert-info" : "alert-warning") mt-3 mb-0">
        <div><b>Đã chọn:</b> @SelectedMovie.Title</div>
        <div class="small text-muted">
          Loại: @SelectedMovie.Type • Số tập hiện có: @CurrentEpisodeCount • Tập lớn nhất: @MaxEpisodeNumber
        </div>
        @if (SelectedMovie.Type != MovieType.Series)
        {
          <div class="small mt-1"><i class="bi bi-exclamation-triangle"></i> Phim này là <b>Single</b>. Bạn vẫn có thể tạo tập, nhưng nên đổi sang <b>Series</b> để đúng logic.</div>
        }
      </div>
    }
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">2) Cấu hình tạo tập</div>
  <div class="card-body">
    <EditForm Model="Form">
      <div class="row g-3">
        <div class="col-6 col-md-3">
          <label class="form-label">Số tập bắt đầu</label>
          <InputNumber class="form-control" @bind-Value="Form.StartNumber" />
          <div class="form-text">Gợi ý: @SuggestedStart</div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Số lượng tập</label>
          <InputNumber class="form-control" @bind-Value="Form.Count" />
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Mẫu tiêu đề</label>
          <InputText class="form-control" @bind-Value="Form.TitlePattern" />
          <div class="form-text">Dùng <code>{n}</code> cho số tập. Ví dụ: <i>Tập {n}</i></div>
        </div>

        <div class="col-12">
          <label class="form-label">Mô tả (tuỳ chọn)</label>
          <InputTextArea class="form-control" @bind-Value="Form.Synopsis" rows="2" />
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Thời lượng (phút)</label>
          <InputNumber class="form-control" @bind-Value="Form.DurationMinutes" />
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Ngày phát bắt đầu</label>
          <InputDate class="form-control" @bind-Value="Form.ReleaseStartDate" />
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Khoảng cách ngày</label>
          <InputNumber class="form-control" @bind-Value="Form.ReleaseIntervalDays" />
          <div class="form-text">Chỉ dùng nếu có ngày bắt đầu</div>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Trạng thái</label>
          <InputSelect class="form-select" @bind-Value="Form.Status">
            @foreach (var s in Enum.GetValues<PublishStatus>())
            {
              <option value="@s">@s</option>
            }
          </InputSelect>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">Chất lượng</label>
          <InputSelect class="form-select" @bind-Value="Form.Quality">
            @foreach (var q in Enum.GetValues<QualityLevel>())
            {
              <option value="@q">@q</option>
            }
          </InputSelect>
        </div>

        <div class="col-6 col-md-3 d-flex align-items-end">
          <div class="form-check">
            <InputCheckbox class="form-check-input" @bind-Value="Form.IsVipOnly" />
            <label class="form-check-label">Chỉ VIP</label>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label">Xử lý khi tập đã tồn tại</label>
          <div class="d-flex gap-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" id="opt1" name="existMode" checked="@Form.OnlyCreateMissing" @onchange="() => SetMode(true, false)" />
              <label class="form-check-label" for="opt1">Chỉ tạo tập chưa có (bỏ qua nếu trùng số)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" id="opt2" name="existMode" checked="@Form.OverwriteExisting" @onchange="() => SetMode(false, true)" />
              <label class="form-check-label" for="opt2">Cập nhật đè tập đã có</label>
            </div>
          </div>
        </div>

        <div class="col-12 d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" @onclick="BuildPreview">
            <i class="bi bi-eye me-1"></i> Xem trước
          </button>
          <button type="button" class="btn btn-primary" disabled="@(!CanCreate)" @onclick="CreateAsync">
            <i class="bi bi-check2-circle me-1"></i> Tạo
          </button>
        </div>
      </div>
    </EditForm>
  </div>
</div>

@if (Preview is not null)
{
  <div class="card">
    <div class="card-header">3) Xem trước</div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0 align-middle">
        <thead>
          <tr>
            <th style="width:100px">Số tập</th>
            <th>Tiêu đề</th>
            <th style="width:170px">Ngày phát</th>
            <th style="width:90px" class="text-center">Đã tồn tại</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var row in Preview)
          {
            <tr class="@(row.Exists ? (Form.OverwriteExisting ? "table-warning" : "table-light") : "")">
              <td>@row.Number</td>
              <td>@row.Title</td>
              <td>@(row.ReleaseDate?.ToString("dd/MM/yyyy"))</td>
              <td class="text-center">
                @if (row.Exists) { <i class="bi bi-check-circle text-warning"></i> } else { <i class="bi bi-dash"></i> }
              </td>
            </tr>
          }
        </tbody>
      </table>
      <div class="p-2 small text-muted">
        @if (Form.OverwriteExisting)
        {
          <span>Sẽ <b>tạo mới</b> các tập chưa có và <b>cập nhật</b> các tập đã tồn tại.</span>
        }
        else
        {
          <span>Sẽ chỉ <b>tạo mới</b> các tập chưa có; tập đã tồn tại sẽ bỏ qua.</span>
        }
      </div>
    </div>
  </div>
}

@if (!string.IsNullOrEmpty(Result))
{
  <div class="alert alert-success mt-3">
    @Result
    @if (Form.MovieId is not null)
    {
      <div class="mt-2">
        <a class="btn btn-sm btn-outline-primary" href="@($"movies/edit/{Form.MovieId}")">Mở phim</a>
      </div>
    }
  </div>
}