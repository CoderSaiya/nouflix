@page "/movies/view/{id:int}"
@rendermode InteractiveServer
@using MoviePortal.Api
@using MoviePortal.Models.DTOs
@using MoviePortal.Models.ValueObject

<PageTitle>@(_movie?.Title ?? "Chi tiết phim")</PageTitle>

@if (_loading) { <p>Đang tải...</p> }
else if (_movie is null) { <div class="alert alert-warning">Không tìm thấy phim.</div> }
else
{
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">@_movie.Title</h3>
    <div class="text-nowrap">
      <a class="btn btn-outline-secondary me-2"  href="/movies">Danh sách</a>
      <a class="btn btn-primary" href="@($"/movies/edit/{_movie.Id}")">Sửa</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-4">
      @if (_posterUrl is not null)
      {
        <img class="img-fluid rounded" src="@_posterUrl" alt="@_movie.Title" />
      }
      else { <div class="text-muted">Chưa có poster.</div> }
    </div>

    <div class="col-md-8">
      <div class="mb-2 text-muted">
        @_movie.Status | @_movie.Type | @_movie.ReleaseDate.ToShortDateString() | Chất lượng: @_movie.Quality
      </div>
      <p>@_movie.Overview</p>

      @if (_movie.Type == MovieType.Single)
      {
        <h5>Video</h5>
        @if (_movieVideos.Count == 0)
        {
          <div class="text-muted">Chưa có video.</div>
        }
        else
        {
          <ul class="list-group">
          @foreach (var v in _movieVideos)
          {
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">@v.Kind - @v.Quality</div>
                <div class="small text-muted">@v.Bucket / @v.ObjectKey</div>
              </div>
              <button class="btn btn-sm btn-outline-primary" @onclick="() => PreviewAsync(v)">Xem thử (10')</button>
            </li>
          }
          </ul>
        }
      }
      else
      {
        <h5>Tập</h5>
        @if (_episodes.Count == 0)
        {
          <div class="text-muted">Chưa có tập.</div>
        }
        else
        {
          <div class="accordion" id="eps">
            @foreach (var e in _episodes)
            {
              <div class="accordion-item">
                <h2 class="accordion-header" id="@($"h{e.Id}")">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="@($"#c{e.Id}")">
                    Tập @e.Number: @e.Title
                  </button>
                </h2>
                <div id="@($"c{e.Id}")" class="accordion-collapse collapse" data-bs-parent="#eps">
                  <div class="accordion-body">
                    <div class="small text-muted mb-2">Trạng thái: @e.Status | Ngày phát: @e.ReleaseDate.ToShortDateString()</div>
                    @if (_videosByEpisode.TryGetValue(e.Id, out var vids) && vids.Count > 0)
                    {
                      <ul class="list-group">
                        @foreach (var v in vids)
                        {
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <div class="fw-bold">@v.Kind - @v.Quality</div>
                              <div class="small text-muted">@v.Bucket / @v.ObjectKey</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => PreviewAsync(v)">Xem thử (10')</button>
                          </li>
                        }
                      </ul>
                    }
                    else
                    {
                      <div class="text-muted">Chưa có video.</div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      }

      @if (!string.IsNullOrEmpty(_previewUrl))
      {
        <div class="mt-3">
          <div class="alert alert-info py-2">
            Link tạm (SAS, hết hạn sau 10 phút): <a href="@_previewUrl" target="_blank">@_previewUrl</a>
          </div>
          <video controls style="width:100%; max-height:420px;">
            <source src="@_previewUrl" type="application/vnd.apple.mpegurl">
            Trình duyệt của bạn có thể không hỗ trợ HLS trực tiếp. Mở link ở tab mới nếu không phát được.
          </video>
        </div>
      }
    </div>
  </div>
}

@code {
  [Parameter] public int Id { get; set; }
  [Inject] public MovieApi MovApi { get; set; } = null!;
  [Inject] public StorageApi StoApi { get; set; } = null!;

  private bool _loading = true;
  private MovieDto.Movie? _movie;
  private string? _posterUrl;

  private List<MovieDto.Episode> _episodes = new();
  private List<MovieDto.VideoAssets> _movieVideos = new();
  private Dictionary<int, List<MovieDto.VideoAssets>> _videosByEpisode = new();

  private string? _previewUrl;

  protected override async Task OnInitializedAsync()
  {
    _movie = await MovApi.GetAsync(Id);
    if (_movie is null)
    {
      _loading = false;
      return;
    }

    _posterUrl = await StoApi.GetImageUrl(Id);

    if (_movie.Type == MovieType.Single)
    {
      _movieVideos = await MovApi.GetVideosAsync(Id);
    }
    else
    {
      _episodes = await MovApi.GetEpisodesByMovieAsync(Id);

      var epIds = _episodes.Select(e => e.Id).ToArray();
      var vids = await MovApi.GetVideoByEpisodeIdsAsync(epIds);

      _videosByEpisode = vids.GroupBy(v => v.EpisodeId!.Value)
                             .ToDictionary(g => g.Key, g => g.ToList());
    }

    _loading = false;
  }

  private async Task PreviewAsync(MovieDto.VideoAssets v)
  {
    _previewUrl = await StoApi.GetPreviewUrl(v.Bucket, v.ObjectKey);
  }
}
