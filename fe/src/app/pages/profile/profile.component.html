<div class="profile-page">
  <div class="container">
    <div class="profile-container">
      <div class="profile-header">
        <h1 class="profile-title">Thông Tin Cá Nhân</h1>
        <button class="btn btn-secondary" (click)="onLogout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Đăng Xuất</span>
        </button>
      </div>

      <div class="tabs-navigation">
        <button
          class="tab-button"
          [class.active]="activeTab() === 'profile'"
          (click)="switchTab('profile')"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Thông Tin</span>
        </button>
        <button
          class="tab-button"
          [class.active]="activeTab() === 'history'"
          (click)="switchTab('history')"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span>Lịch Sử Xem</span>
        </button>
        <button
          class="tab-button"
          [class.active]="activeTab() === 'watchlist'"
          (click)="switchTab('watchlist')"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          <span>Danh Sách Lưu</span>
        </button>
      </div>

      @if (success()) {
        <div class="alert alert-success">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span>{{ success() }}</span>
        </div>
      }

      @if (error()) {
        <div class="alert alert-error">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>{{ error() }}</span>
        </div>
      }

      @if (activeTab() === 'profile') {
        <div class="profile-content">
          <div class="profile-sidebar">
            <div class="avatar-section">
              <div class="avatar-wrapper">
                @if (avatarPreview) {
                  <img [src]="avatarPreview" alt="Avatar" class="avatar-image" />
                } @else {
                  <div class="avatar-placeholder">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                }
              </div>

              <label for="avatar-input" class="btn btn-secondary btn-small">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
                <span>Thay đổi ảnh</span>
              </label>
              <input
                id="avatar-input"
                type="file"
                accept="image/*"
                (change)="onAvatarChange($event)"
                style="display: none;"
              />
            </div>

            <div class="user-info-card">
              <h3 class="info-card-title">Thông tin tài khoản</h3>
              <div class="info-item">
                <span class="info-label">Email</span>
                <span class="info-value">{{ user()?.email }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Ngày tạo</span>
                <span class="info-value">{{ user()?.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </div>
          </div>

          <div class="profile-main">
            <form class="profile-form" (ngSubmit)="onSubmit()">
              <div class="form-section">
                <h2 class="section-title">Thông tin cá nhân</h2>

                <div class="form-row">
                  <div class="form-group">
                    <label for="firstName" class="form-label">Họ</label>
                    <input
                      id="firstName"
                      type="text"
                      class="form-input"
                      placeholder="Nhập họ của bạn"
                      [(ngModel)]="firstName"
                      name="firstName"
                      [disabled]="isLoading()"
                    />
                  </div>

                  <div class="form-group">
                    <label for="lastName" class="form-label">Tên</label>
                    <input
                      id="lastName"
                      type="text"
                      class="form-input"
                      placeholder="Nhập tên của bạn"
                      [(ngModel)]="lastName"
                      name="lastName"
                      [disabled]="isLoading()"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="dateOfBirth" class="form-label">Ngày sinh</label>
                  <input
                    id="dateOfBirth"
                    type="date"
                    class="form-input"
                    [(ngModel)]="dateOfBirth"
                    name="dateOfBirth"
                    [disabled]="isLoading()"
                  />
                </div>
              </div>

              <div class="form-section">
                <h2 class="section-title">Bảo mật</h2>

                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-input"
                    [value]="user()?.email"
                    disabled
                    readonly
                  />
                  <p class="form-hint">Email không thể thay đổi</p>
                </div>

                <div class="form-group">
                  <label class="form-label">Mật khẩu</label>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    (click)="openPasswordModal()"
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    <span>Đổi mật khẩu</span>
                  </button>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <span class="spinner"></span>
                    <span>Đang lưu...</span>
                  } @else {
                    <span>Lưu thay đổi</span>
                  }
                </button>
              </div>
            </form>
          </div>
        </div>
      }

      <!-- Watch History Tab -->
      @if (activeTab() === 'history') {
        <div class="history-content">
          @if (isLoadingHistory()) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Đang tải lịch sử xem...</p>
            </div>
          } @else if (watchHistory().length === 0) {
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <h3>Chưa có lịch sử xem</h3>
              <p>Bắt đầu xem phim để tạo lịch sử xem của bạn</p>
            </div>
          } @else {
            <div class="history-grid">
              @for (item of watchHistory(); track item.item.movieId) {
                <div class="history-card">
                  @if (item.movie) {
                    <div class="history-poster">
                      <img [src]="item.movie.posterUrl" [alt]="item.movie.title" />
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="item.item.progress"></div>
                      </div>
                    </div>
                    <div class="history-info">
                      <h4 class="history-title">{{ item.movie.title }}</h4>
                      <p class="history-date">{{ item.item.watchedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
                      <p class="history-progress">{{ item.item.progress }}% đã xem</p>
                      <a [routerLink]="['/watch', item.movie.id]" class="btn btn-primary btn-small">
                        Tiếp tục xem
                      </a>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Watchlist Tab -->
      @if (activeTab() === 'watchlist') {
        <div class="watchlist-content">
          @if (isLoadingWatchlist()) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Đang tải danh sách lưu...</p>
            </div>
          } @else if (watchlist().length === 0) {
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              <h3>Danh sách lưu trống</h3>
              <p>Thêm phim vào danh sách lưu để xem sau</p>
            </div>
          } @else {
            <div class="watchlist-grid">
              @for (item of watchlist(); track item.item.movieId) {
                <div class="watchlist-card">
                  @if (item.movie) {
                    <div class="watchlist-poster">
                      <img [src]="item.movie.posterUrl" [alt]="item.movie.title" />
                      <div class="watchlist-overlay">
                        <a [routerLink]="['/watch', item.movie.id]" class="btn btn-primary btn-small">
                          Xem ngay
                        </a>
                        <button
                          class="btn btn-secondary btn-small"
                          (click)="removeFromWatchlist(item.movie.id)"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 4 21 4"></polyline>
                            <path d="M19 4v20a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4"></path>
                            <path d="M10 11v6"></path>
                            <path d="M14 11v6"></path>
                          </svg>
                          Xóa
                        </button>
                      </div>
                    </div>
                    <div class="watchlist-info">
                      <h4 class="watchlist-title">{{ item.movie.title }}</h4>
                      <p class="watchlist-rating">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <polygon points="12 2 15.09 10.26 23.77 10.5 17.94 16.51 20.16 25.23 12 20.01 3.84 25.23 6.06 16.51 0.23 10.5 8.91 10.26"></polygon>
                        </svg>
                        {{ item.movie.avgRating }}/10
                      </p>
                      <p class="watchlist-date">Thêm vào: {{ item.item.addedAt | date: 'dd/MM/yyyy' }}</p>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>

@if (showPasswordModal()) {
  <app-change-password-modal (close)="closePasswordModal()"></app-change-password-modal>
}
