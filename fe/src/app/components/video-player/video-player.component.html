<div class="video-player" [class.theater-mode]="isTheaterMode" [class.fullscreen]="isFullscreen" (mousemove)="onMouseMove()">
  <div class="video-container">
    <!-- video thật phát HLS (KHÔNG dùng native controls) -->
    <video
      #videoElement
      playsinline
      preload="metadata"
      [attr.poster]="movie.backdropUrl || null"
      style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; z-index:1;"
    ></video>

    <!-- placeholder chỉ hiển thị khi chưa play -->
    <div
      class="video-placeholder"
      [style.background-image]="'url(' + movie.backdropUrl + ')'"
      [style.display]="isPlaying ? 'none' : 'flex'"
      style="position:absolute; inset:0; z-index:0;"
    >
      @if (!isPlaying) {
        <div class="play-overlay" (click)="togglePlay()">
          <div class="play-button">
            <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
              <circle cx="40" cy="40" r="40" fill="rgba(255,255,255,0.9)" />
              <path d="M32 25L55 40L32 55V25Z" fill="#000" />
            </svg>
          </div>
        </div>
      }

      @if (buffered < 5 && !isPlaying) {
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      }
    </div>

    <!-- UI custom theo SCSS của bạn -->
    <div class="controls-overlay" [class.visible]="showControls || !isPlaying" style="z-index:2;">
      <div class="top-bar">
        <div class="movie-title">
          <h3>{{ movie.title }}</h3>
          <span class="quality-badge">{{ selectedQuality }}</span>
        </div>
      </div>

      <div class="center-controls">
        <button class="control-btn" (click)="skipBackward()" title="Lùi 10s">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38" />
            <text x="12" y="16" text-anchor="middle" font-size="8" fill="currentColor">10</text>
          </svg>
        </button>

        <button class="control-btn play-btn" (click)="togglePlay()">
          @if (isPlaying) {
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="4" width="4" height="16" />
              <rect x="14" y="4" width="4" height="16" />
            </svg>
          } @else {
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z" />
            </svg>
          }
        </button>

        <button class="control-btn" (click)="skipForward()" title="Tua 10s">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38" />
            <text x="12" y="16" text-anchor="middle" font-size="8" fill="currentColor">10</text>
          </svg>
        </button>
      </div>

      <div class="bottom-bar">
        <div class="progress-container" (click)="onProgressClick($event)">
          <div class="progress-buffer" [style.width.%]="buffered"></div>
          <div class="progress-bar" [style.width.%]="progressPercent">
            <div class="progress-handle"></div>
          </div>
        </div>

        <div class="controls">
          <div class="controls-left">
            <button class="control-btn small" (click)="togglePlay()">
              @if (isPlaying) {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <rect x="6" y="4" width="4" height="16" />
                  <rect x="14" y="4" width="4" height="16" />
                </svg>
              } @else {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z" />
                </svg>
              }
            </button>

            <button class="control-btn small" (click)="skipForward()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 4 15 12 5 20 5 4" />
                <line x1="19" y1="5" x2="19" y2="19" />
              </svg>
            </button>

            <div class="volume-control">
              <button class="control-btn small" (click)="toggleMute()">
                <span>{{ volumeIcon }}</span>
              </button>
              <input
                type="range"
                min="0"
                max="1"
                step="0.1"
                [value]="volume"
                (input)="onVolumeChange($event)"
                class="volume-slider"
              />
            </div>

            <div class="time-display">
              <span>{{ formatTime(currentTime) }} / {{ formatTime(duration) }}</span>
            </div>
          </div>

          <div class="controls-right">
            <div class="settings-menu">
              <button class="control-btn small" (click)="toggleSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"
                  />
                </svg>
              </button>

              @if (showSettings) {
                <div class="settings-dropdown">
                  <div class="settings-item" (click)="toggleQuality()">
                    <span>Chất lượng</span>
                    <span>{{ selectedQuality }} ›</span>
                  </div>
                  <div class="settings-divider"></div>
                  <div class="settings-label">Tốc độ phát</div>
                  @for (rate of playbackRates; track rate) {
                    <div
                      class="settings-item"
                      [class.active]="playbackRate === rate"
                      (click)="selectPlaybackRate(rate)"
                    >
                      <span>{{ rate }}x</span>
                      @if (playbackRate === rate) { <span>✓</span> }
                    </div>
                  }
                </div>
              }

              @if (showQuality) {
                <div class="settings-dropdown quality-dropdown">
                  <div class="settings-header" (click)="toggleQuality()">
                    <span>‹ Chất lượng</span>
                  </div>
                  @for (quality of qualities; track quality) {
                    <div
                      class="settings-item"
                      [class.active]="selectedQuality === quality"
                      (click)="selectQuality(quality)"
                    >
                      <span>{{ quality }}</span>
                      @if (selectedQuality === quality) { <span>✓</span> }
                    </div>
                  }
                </div>
              }
            </div>

            <button class="control-btn small" (click)="toggleTheaterMode()" title="Chế độ rạp">
              @if (isTheaterMode) {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" />
                </svg>
              } @else {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="2" y="7" width="20" height="10" rx="2" />
                </svg>
              }
            </button>

            <button class="control-btn small" (click)="toggleFullscreen()" title="Toàn màn hình">
              @if (isFullscreen) {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3" />
                </svg>
              } @else {
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3" />
                </svg>
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
